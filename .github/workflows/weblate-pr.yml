name: Weblate Translation PR

on:
  push:
    branches:
      - weblate

jobs:
  create-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;

            // Compare branches
            const comparison = await github.rest.repos.compareCommits({
              owner,
              repo,
              base: 'master',
              head: 'weblate'
            });

            console.log('Comparison:', comparison.data.status, 'ahead by', comparison.data.ahead_by, 'commits');

            // Skip if no changes
            if (comparison.data.status === 'identical' || comparison.data.ahead_by === 0) {
              console.log('No changes - skipping PR creation');
              return;
            }

            // Check for existing PR
            const { data: pulls } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              head: owner + ':weblate',
              base: 'master'
            });

            if (pulls.length > 0) {
              console.log('PR #' + pulls[0].number + ' already exists');
              return;
            }

            // Create PR
            const { data: pr } = await github.rest.pulls.create({
              owner,
              repo,
              title: 'Translation updates from Weblate',
              body: '## Translation Updates from Weblate\n\nThis PR contains the latest translation updates automatically synced from Weblate.\n\n### Review Checklist\n- [ ] Translation changes look correct\n- [ ] No unexpected file modifications\n- [ ] Ready to merge\n\n---\nAuto-generated by GitHub Actions',
              head: 'weblate',
              base: 'master'
            });

            console.log('PR #' + pr.number + ' created:', pr.html_url);

            // Add labels and assignee
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: pr.number,
              labels: ['translations', 'weblate', 'i18n']
            });

            await github.rest.issues.addAssignees({
              owner,
              repo,
              issue_number: pr.number,
              assignees: ['eliakassoufshelvz']
            });

            console.log('Done!');
