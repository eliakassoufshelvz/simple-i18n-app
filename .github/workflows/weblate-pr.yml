name: Weblate Translation PR

on:
  push:
    branches:
      - weblate

jobs:
  create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout weblate branch
        uses: actions/checkout@v4
        with:
          ref: weblate
          fetch-depth: 0

      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;

            console.log('Checking for differences between weblate and master...');

            // Compare branches
            let comparison;
            try {
              comparison = await github.rest.repos.compareCommits({
                owner,
                repo,
                base: 'master',
                head: 'weblate'
              });
            } catch (error) {
              console.log('Error comparing branches:', error.message);
              throw error;
            }

            console.log('Status:', comparison.data.status);
            console.log('Ahead by:', comparison.data.ahead_by, 'commits');
            console.log('Behind by:', comparison.data.behind_by, 'commits');
            console.log('Total commits:', comparison.data.total_commits);

            // If branches are identical, skip
            if (comparison.data.status === 'identical') {
              console.log('Branches are identical - no PR needed');
              return;
            }

            // If weblate is behind master, skip
            if (comparison.data.ahead_by === 0) {
              console.log('No new commits in weblate - no PR needed');
              return;
            }

            console.log('Changes detected - checking for existing PR...');

            // Check if PR already exists
            const { data: pulls } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              head: owner + ':weblate',
              base: 'master'
            });

            if (pulls.length > 0) {
              console.log('PR #' + pulls[0].number + ' already exists and will auto-update');
              console.log('URL:', pulls[0].html_url);
              return;
            }

            console.log('Creating new PR...');

            const prBody = '## Translation Updates from Weblate\n\n' +
              'This PR contains the latest translation updates automatically synced from Weblate.\n\n' +
              '### Changes\n' +
              '- Automatically synced from Weblate platform\n' +
              '- Contains updates to translation files\n\n' +
              '### Review Checklist\n' +
              '- [ ] Translation changes look correct\n' +
              '- [ ] No unexpected file modifications\n' +
              '- [ ] Ready to merge\n\n' +
              '---\n' +
              'Note: This PR is automatically updated when new translations are pushed from Weblate.\n\n' +
              'Auto-generated by GitHub Actions';

            // Create PR
            const { data: pr } = await github.rest.pulls.create({
              owner,
              repo,
              title: 'Translation updates from Weblate',
              body: prBody,
              head: 'weblate',
              base: 'master'
            });

            console.log('PR #' + pr.number + ' created successfully!');
            console.log('URL:', pr.html_url);

            // Add labels
            try {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: pr.number,
                labels: ['translations', 'weblate', 'i18n']
              });
              console.log('Labels added');
            } catch (error) {
              console.log('Warning: Could not add labels:', error.message);
            }

            // Add assignee
            try {
              await github.rest.issues.addAssignees({
                owner,
                repo,
                issue_number: pr.number,
                assignees: ['eliakassoufshelvz']
              });
              console.log('Assignee added');
            } catch (error) {
              console.log('Warning: Could not add assignee:', error.message);
            }

            console.log('All done!');
