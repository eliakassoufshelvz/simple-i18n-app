name: Weblate Translation PR

on:
  push:
    branches:
      - weblate

jobs:
  create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for differences between branches
        id: check-diff
        run: |
          git fetch origin master
          git fetch origin weblate

          if git diff --quiet origin/master origin/weblate; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No differences found between branches"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Differences found:"
            git diff --stat origin/master origin/weblate
          fi

      - name: Check if PR exists
        if: steps.check-diff.outputs.has_changes == 'true'
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_COUNT=$(gh pr list --repo ${{ github.repository }} --head weblate --base master --state open --json number --jq 'length')
          echo "pr_exists=$([[ $PR_COUNT -gt 0 ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          if [[ $PR_COUNT -gt 0 ]]; then
            echo "Existing PR found"
          else
            echo "No existing PR found"
          fi

      - name: Create Pull Request
        if: steps.check-diff.outputs.has_changes == 'true' && steps.check-pr.outputs.pr_exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --repo ${{ github.repository }} \
            --base master \
            --head weblate \
            --title "üåê Translation updates from Weblate" \
            --body "## Translation Updates from Weblate

          This PR contains the latest translation updates automatically synced from Weblate.

          ### Changes
          - Automatically synced from Weblate platform
          - Contains updates to translation files

          ### Review Checklist
          - [ ] Translation changes look correct
          - [ ] No unexpected file modifications
          - [ ] Ready to merge

          ---
          üìù **Note**: This PR is automatically updated when new translations are pushed from Weblate.

          ü§ñ *Auto-generated by GitHub Actions*" \
            --label "translations,weblate,i18n" \
            --assignee "eliakassoufshelvz" || {
              echo "Failed to create PR. Error details above."
              exit 1
            }

      - name: PR already exists
        if: steps.check-diff.outputs.has_changes == 'true' && steps.check-pr.outputs.pr_exists == 'true'
        run: |
          echo "PR already exists and will be automatically updated with new commits"

      - name: No changes needed
        if: steps.check-diff.outputs.has_changes == 'false'
        run: |
          echo "No changes between branches - workflow completed successfully"
